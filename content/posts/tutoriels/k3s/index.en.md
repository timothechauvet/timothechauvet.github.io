---
title: "Single-node Kubernetes with ingresses ‚ò∏Ô∏è"
date: 2024-12-16
hero: k3s.webp
description: How I set up my own mono-Kubernetes
theme: Toha
---

For a friend, I [did a Telegram bot and containerized the app with Docker](../telegram-bot-python/). In reality, that was the beginning of a long struggle to keep only Docker and configure a reverse proxy, because I'm really bad at that.

Instead, **I installed [k3s](https://k3s.io/), which allowed me to have single-node Kubernetes**, meaning all running on a single VM. Kubernetes makes it possible to orchestrate containers, thus solving many of my issues.

{{< vs 4 >}}

<p align="center">
  {{< img src="/posts/tutoriels/k3s/k3s-illu.webp" width="400" align="center" alt="Red-orange illustration of a computer screen with the k3s logo in front" >}}
  <p style="text-align: center;"><i>"k3s" banner generated by Flux with Perplexity</i></p>
</p>

{{< vs 4 >}}

## How to do it

This tutorial is nothing amazing, but I made it because k3s doesn‚Äôt come with all the features I needed. Here‚Äôs how to proceed.

1. Have a Linux VM. At least 2 CPUs and 2 GB of RAM are sufficient
1. Make sure ports *80* and *443* are open inbound (NSG, firewall, iptables, ufw, depending on what you have)
1. Install [Docker](https://docs.docker.com/desktop/setup/install/linux/) (unless containerD is enough for you)
1. Install k3s: `curl -sfL https://get.k3s.io | sh -`
1. Enable k3s on next reboot with `sudo systemctl enable k3s`
1. Add the line `export KUBECONFIG=/etc/rancher/k3s/k3s.yaml` to your rc file (.bashrc, .zshrc, etc.)
   - Note: if you encounter problems, you can relax the permissions of the k3s file with `sudo chmod 644 /etc/rancher/k3s/k3s.yaml` (not recommended)
1. Install ingress-nginx for your Ingress resources (if using a cloud provider) with `kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.11.3/deploy/static/provider/cloud/deploy.yaml`
1. Install cert-manager to enable HTTPS later with `kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.16.1/cert-manager.yaml`
1. Install MetalLB to create LoadBalancers/Ingresses with `kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.8/config/manifests/metallb-native.yaml`

{{< vs 2 >}}

{{< alert type="info" >}}
For all the `.yaml` files below, you can apply them with the command:  
`kubectl apply -f myfile.yaml`
{{< /alert >}}

{{< vs 4 >}}

### Configuring MetalLB

MetalLB needs to be able to create LoadBalancers using a pool of available IPs. To determine which range to use:

- Run `hostname -I`.
- Pick a range of addresses that doesn‚Äôt overlap with the listed IPs.

Create and apply the file `metallb.yaml`:

```yaml
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: first-pool
  namespace: metallb-system
spec:
  addresses:
  - 10.0.0.240-10.0.0.250 # adjust according to your network

---
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: l2-advert
  namespace: metallb-system
spec:
  ipAddressPools:
  - first-pool
```

{{< vs 4 >}}

### Configuring Let's Encrypt

Let's Encrypt must confirm that you own your domain names. Create a file `clusterissuer-letsencrypt.yaml`:

```yaml
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: timothe@chauvet.cloud # replace this
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
    - http01:
        ingress:
          class: traefik # replace this if you want nginx
```

{{< vs 2 >}}

If you need a certificate, you can create one with a file like `certificate-yourls.yaml`:

```yaml
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: yourls-tls
  namespace: default
spec:
  secretName: yourls-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
  - tmth.fr
```

{{< vs 4 >}}

## Hosting My Apps

### My Telegram Bot

For my Telegram bot, it was quite simple because it doesn‚Äôt need to receive HTTP requests. A simple Deployment was enough:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: telebot
spec:
  replicas: 1
  selector:
    matchLabels:
      app: telebot
  template:
    metadata:
      labels:
        app: telebot
    spec:
      restartPolicy: Always
      containers:
      - name: telebot
        image: ghcr.io/timothechauvet/telebot:latest
        env:
        - name: TELEGRAM_BOT_TOKEN
          valueFrom:
            secretKeyRef:
              name: telebot-secrets
              key: TELEGRAM_BOT_TOKEN
      imagePullSecrets:
      - name: ghcr-secret
```

{{< vs 4 >}}

### An HTTP App

I wanted an URL shortener. You may have already seen it by clicking on [tmth.fr/k3s](https://tmth.fr/k3s) to come here! I used [Yourls](https://yourls.org/) for that. It requires a MySQL database. That was the trickiest part to set up.

For Yourls, I needed:

- A ConfigMap with `config.php`
- A Certificate for my domain tmth.fr
- A Traefik Ingress (I prefer that because Nginx is for smart people üò≠)
- The Service to map to the Ingress
- A PersistentVolume and its claim for the MySQL database
- The Deployment, of course.

I think the most important one is the Ingress which creates rules for when a request to tmth.fr is made

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: yourls-ingress
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    traefik.ingress.kubernetes.io/router.entrypoints: "web,websecure"
spec:
  ingressClassName: traefik
  tls:
  - hosts:
    - tmth.fr
    secretName: yourls-tls
  rules:
  - host: tmth.fr
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: yourls
            port: 
              number: 80
```

{{< vs 2 >}}

I‚Äôm obviously not going to publish ALL my configurations here.

{{< img src="https://risibank.fr/cache/medias/0/23/2399/239915/full.gif" height="200" align="left" title="Alas!!" >}}

{{< vs 2 >}}

**Alas!!**

I published my configurations, that you can [find on my GitHub](https://github.com/timothechauvet/mes-yaml-de-kube/). Feel free to use them as examples!

---

If you have any questions or suggestions, don‚Äôt hesitate to contact me by [email](mailto:timothe@chauvet.cloud), on [LinkedIn](https://www.linkedin.com/in/timothechauvet/), or by sending [an issue on GitHub](https://github.com/timothechauvet/timothechauvet.github.io/issues).